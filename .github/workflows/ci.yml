# ╔═══════════════════════════════════════════════════════════════════════════════╗
# ║  ForgeComply 360 Reporter — CI/CD Pipeline                                  ║
# ║                                                                              ║
# ║  End-to-end workflow: quality → test → build → validation → deploy → verify  ║
# ║                                                                              ║
# ║  User Input (push/PR)                                                        ║
# ║       │                                                                      ║
# ║       ▼                                                                      ║
# ║  [1] Quality Gate — lint, type-check, security audit                         ║
# ║       │                                                                      ║
# ║       ├──────────────┬────────────────┐  (parallel)                          ║
# ║       ▼              ▼                ▼                                       ║
# ║  [2] Test       [3] Build       [4] Validation                               ║
# ║   280 tests      dist/ bundle    OSCAL schema                                ║
# ║   coverage        size analysis  SBOM generation                             ║
# ║       │              │                │                                       ║
# ║       └──────────────┴────────────────┘                                      ║
# ║                      │                                                        ║
# ║                      ▼                                                        ║
# ║  [5] Deploy — Cloudflare Pages (preview for PR / production for main)        ║
# ║                      │                                                        ║
# ║                      ▼                                                        ║
# ║  [6] Verify — smoke tests (HTTP 200 + content check)                         ║
# ║                      │                                                        ║
# ║                      ▼                                                        ║
# ║  Output: deployed app + artifacts (SBOM, coverage, bundle report)            ║
# ╚═══════════════════════════════════════════════════════════════════════════════╝

name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs for the same branch/PR.
# Production deploys on main are never cancelled mid-flight.
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

# Least-privilege: only grant what is needed at the workflow level,
# then elevate per-job where required.
permissions:
  contents: read

env:
  NODE_VERSION: "20"
  # Coverage thresholds — fail the build if any metric drops below these
  COVERAGE_THRESHOLD_LINES: 25
  COVERAGE_THRESHOLD_BRANCHES: 50
  COVERAGE_THRESHOLD_FUNCTIONS: 55
  COVERAGE_THRESHOLD_STATEMENTS: 25

# =============================================================================
# STAGE 1: QUALITY GATE
# =============================================================================
jobs:
  quality-gate:
    name: "1. Quality Gate"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # ── Lint ──────────────────────────────────────────────────────────────
      - name: ESLint
        id: lint
        run: npm run lint

      # ── Type Check ────────────────────────────────────────────────────────
      - name: TypeScript type check
        id: typecheck
        run: npx tsc --noEmit

      # ── Security Audit ────────────────────────────────────────────────────
      - name: Security audit (high + critical)
        id: audit
        run: |
          npm audit --audit-level=high --json > audit-results.json 2>&1 || true
          VULN_COUNT=$(node -e "
            try {
              const r = require('./audit-results.json');
              const m = r.metadata?.vulnerabilities || {};
              console.log((m.high || 0) + (m.critical || 0));
            } catch { console.log('0'); }
          ")
          echo "vuln_count=${VULN_COUNT}" >> "$GITHUB_OUTPUT"
          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "::warning::Found ${VULN_COUNT} high/critical vulnerabilities"
          fi

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-results
          path: audit-results.json
          retention-days: 30

      # ── Job Summary ───────────────────────────────────────────────────────
      - name: Write job summary
        if: always()
        run: |
          echo "## 1. Quality Gate Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Check | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| ESLint | ${{ steps.lint.outcome == 'success' && 'Passed' || 'Failed' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| TypeScript | ${{ steps.typecheck.outcome == 'success' && 'Passed' || 'Failed' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Security Audit | ${{ steps.audit.outputs.vuln_count == '0' && 'No high/critical vulns' || format('{0} high/critical vulns', steps.audit.outputs.vuln_count) }} |" >> "$GITHUB_STEP_SUMMARY"

  # ===========================================================================
  # STAGE 2: TEST (Unit Tests + Coverage Thresholds)
  # ===========================================================================
  test:
    name: "2. Test"
    runs-on: ubuntu-latest
    needs: quality-gate
    timeout-minutes: 15

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # ── Run Tests with Coverage ───────────────────────────────────────────
      - name: Run tests with coverage
        id: tests
        run: npx vitest run --coverage --reporter=verbose 2>&1 | tee test-output.txt

      # ── Coverage Threshold Check ──────────────────────────────────────────
      - name: Check coverage thresholds
        id: coverage_check
        if: always() && steps.tests.outcome == 'success'
        run: |
          COVERAGE_JSON="coverage/coverage-summary.json"
          if [ ! -f "$COVERAGE_JSON" ]; then
            echo "::error::Coverage summary not found at $COVERAGE_JSON"
            exit 1
          fi

          LINES=$(node -e "const c = require('./$COVERAGE_JSON'); console.log(c.total.lines.pct)")
          BRANCHES=$(node -e "const c = require('./$COVERAGE_JSON'); console.log(c.total.branches.pct)")
          FUNCTIONS=$(node -e "const c = require('./$COVERAGE_JSON'); console.log(c.total.functions.pct)")
          STATEMENTS=$(node -e "const c = require('./$COVERAGE_JSON'); console.log(c.total.statements.pct)")

          echo "lines=${LINES}" >> "$GITHUB_OUTPUT"
          echo "branches=${BRANCHES}" >> "$GITHUB_OUTPUT"
          echo "functions=${FUNCTIONS}" >> "$GITHUB_OUTPUT"
          echo "statements=${STATEMENTS}" >> "$GITHUB_OUTPUT"

          FAILED=0
          if (( $(echo "$LINES < $COVERAGE_THRESHOLD_LINES" | bc -l) )); then
            echo "::error::Line coverage ${LINES}% is below threshold ${COVERAGE_THRESHOLD_LINES}%"
            FAILED=1
          fi
          if (( $(echo "$BRANCHES < $COVERAGE_THRESHOLD_BRANCHES" | bc -l) )); then
            echo "::error::Branch coverage ${BRANCHES}% is below threshold ${COVERAGE_THRESHOLD_BRANCHES}%"
            FAILED=1
          fi
          if (( $(echo "$FUNCTIONS < $COVERAGE_THRESHOLD_FUNCTIONS" | bc -l) )); then
            echo "::error::Function coverage ${FUNCTIONS}% is below threshold ${COVERAGE_THRESHOLD_FUNCTIONS}%"
            FAILED=1
          fi
          if (( $(echo "$STATEMENTS < $COVERAGE_THRESHOLD_STATEMENTS" | bc -l) )); then
            echo "::error::Statement coverage ${STATEMENTS}% is below threshold ${COVERAGE_THRESHOLD_STATEMENTS}%"
            FAILED=1
          fi

          if [ "$FAILED" -eq 1 ]; then
            exit 1
          fi
          echo "All coverage thresholds met."

      # ── Upload Coverage Artifacts ─────────────────────────────────────────
      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 14

      - name: Upload test output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-output
          path: test-output.txt
          retention-days: 14

      # ── PR Coverage Comment ───────────────────────────────────────────────
      - name: Comment coverage on PR
        if: github.event_name == 'pull_request' && always() && steps.coverage_check.outcome != 'skipped'
        uses: actions/github-script@v7
        with:
          script: |
            const lines = '${{ steps.coverage_check.outputs.lines }}';
            const branches = '${{ steps.coverage_check.outputs.branches }}';
            const functions = '${{ steps.coverage_check.outputs.functions }}';
            const statements = '${{ steps.coverage_check.outputs.statements }}';

            const tLines = '${{ env.COVERAGE_THRESHOLD_LINES }}';
            const tBranches = '${{ env.COVERAGE_THRESHOLD_BRANCHES }}';
            const tFunctions = '${{ env.COVERAGE_THRESHOLD_FUNCTIONS }}';
            const tStatements = '${{ env.COVERAGE_THRESHOLD_STATEMENTS }}';

            const icon = (a, t) => parseFloat(a) >= parseFloat(t) ? 'Pass' : 'FAIL';

            const body = [
              '## Test Coverage Report',
              '',
              '| Metric | Coverage | Threshold | Status |',
              '|--------|----------|-----------|--------|',
              `| Lines | ${lines}% | ${tLines}% | ${icon(lines, tLines)} |`,
              `| Branches | ${branches}% | ${tBranches}% | ${icon(branches, tBranches)} |`,
              `| Functions | ${functions}% | ${tFunctions}% | ${icon(functions, tFunctions)} |`,
              `| Statements | ${statements}% | ${tStatements}% | ${icon(statements, tStatements)} |`,
              '',
              '<details>',
              '<summary>Full report</summary>',
              '',
              'Download the `coverage-report` artifact from the Actions tab for the full HTML coverage report.',
              '</details>',
              '',
              '<!-- coverage-report-comment -->',
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.body.includes('<!-- coverage-report-comment -->'));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      # ── Job Summary ───────────────────────────────────────────────────────
      - name: Write job summary
        if: always()
        run: |
          echo "## 2. Test Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Coverage" >> "$GITHUB_STEP_SUMMARY"
          echo "| Metric | Value | Threshold |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|-------|-----------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Lines | ${{ steps.coverage_check.outputs.lines }}% | ${{ env.COVERAGE_THRESHOLD_LINES }}% |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Branches | ${{ steps.coverage_check.outputs.branches }}% | ${{ env.COVERAGE_THRESHOLD_BRANCHES }}% |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Functions | ${{ steps.coverage_check.outputs.functions }}% | ${{ env.COVERAGE_THRESHOLD_FUNCTIONS }}% |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Statements | ${{ steps.coverage_check.outputs.statements }}% | ${{ env.COVERAGE_THRESHOLD_STATEMENTS }}% |" >> "$GITHUB_STEP_SUMMARY"

  # ===========================================================================
  # STAGE 3: BUILD (Production Build + Bundle Analysis)
  # ===========================================================================
  build:
    name: "3. Build"
    runs-on: ubuntu-latest
    needs: quality-gate
    timeout-minutes: 10

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # ── Production Build ──────────────────────────────────────────────────
      - name: Build
        run: npm run build

      # ── Bundle Size Analysis ──────────────────────────────────────────────
      - name: Analyze bundle size
        id: bundle
        run: |
          echo "## Bundle Size Report" > bundle-report.md
          echo "" >> bundle-report.md
          echo "| File | Size | Gzipped |" >> bundle-report.md
          echo "|------|------|---------|" >> bundle-report.md

          TOTAL_RAW=0
          TOTAL_GZ=0

          for f in dist/assets/*.js dist/assets/*.css; do
            if [ -f "$f" ]; then
              FILENAME=$(basename "$f")
              RAW_SIZE=$(stat --format=%s "$f")
              GZ_SIZE=$(gzip -c "$f" | wc -c)

              TOTAL_RAW=$((TOTAL_RAW + RAW_SIZE))
              TOTAL_GZ=$((TOTAL_GZ + GZ_SIZE))

              RAW_KB=$(echo "scale=1; $RAW_SIZE / 1024" | bc)
              GZ_KB=$(echo "scale=1; $GZ_SIZE / 1024" | bc)

              echo "| \`${FILENAME}\` | ${RAW_KB} KB | ${GZ_KB} KB |" >> bundle-report.md
            fi
          done

          TOTAL_RAW_KB=$(echo "scale=1; $TOTAL_RAW / 1024" | bc)
          TOTAL_GZ_KB=$(echo "scale=1; $TOTAL_GZ / 1024" | bc)
          echo "| **Total** | **${TOTAL_RAW_KB} KB** | **${TOTAL_GZ_KB} KB** |" >> bundle-report.md
          echo "" >> bundle-report.md
          echo "_Chunks: oscal, pdf, ai, vendor-ajv, vendor-pdf, vendor-xml (Vite manualChunks)_" >> bundle-report.md

          echo "total_raw=${TOTAL_RAW_KB}" >> "$GITHUB_OUTPUT"
          echo "total_gz=${TOTAL_GZ_KB}" >> "$GITHUB_OUTPUT"

          # Warn if total gzipped exceeds 500 KB
          OVER=$(echo "$TOTAL_GZ > 512000" | bc)
          if [ "$OVER" -eq 1 ]; then
            echo "::warning::Total gzipped bundle exceeds 500 KB (${TOTAL_GZ_KB} KB)"
          fi

      - name: Upload bundle report
        uses: actions/upload-artifact@v4
        with:
          name: bundle-report
          path: bundle-report.md
          retention-days: 14

      # ── PR Bundle Size Comment ────────────────────────────────────────────
      - name: Comment bundle size on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('bundle-report.md', 'utf8');

            const body = `${report}\n\n<!-- bundle-size-comment -->`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.body.includes('<!-- bundle-size-comment -->'));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      # ── Upload Build Artifact ─────────────────────────────────────────────
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

      # ── Job Summary ───────────────────────────────────────────────────────
      - name: Write job summary
        if: always()
        run: |
          echo "## 3. Build Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          cat bundle-report.md >> "$GITHUB_STEP_SUMMARY"

  # ===========================================================================
  # STAGE 4: VALIDATION (OSCAL Schema + SBOM)
  # ===========================================================================
  validation:
    name: "4. Validation"
    runs-on: ubuntu-latest
    needs: quality-gate
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # ── OSCAL Schema Validation Tests ─────────────────────────────────────
      - name: OSCAL schema validation tests
        run: |
          npx vitest run \
            src/utils/oscalImport.test.ts \
            src/tests/deploy-data-input.test.ts \
            --reporter=verbose

      # ── Validate OSCAL JSON Schema File ───────────────────────────────────
      - name: Verify OSCAL 1.1.2 schema integrity
        run: |
          SCHEMA_FILE="src/schemas/oscal/oscal_ssp_schema.json"
          if [ ! -f "$SCHEMA_FILE" ]; then
            echo "::error::OSCAL SSP schema file not found at $SCHEMA_FILE"
            exit 1
          fi
          node -e "
            const fs = require('fs');
            const schema = JSON.parse(fs.readFileSync('$SCHEMA_FILE', 'utf8'));
            console.log('Schema ID:', schema['\$id'] || 'N/A');
            console.log('Schema title:', schema.title || 'N/A');
            console.log('Status: Valid JSON, parseable');
          "

      # ── SBOM Generation (CycloneDX) ──────────────────────────────────────
      - name: Generate SBOM (CycloneDX)
        run: |
          npx --yes @cyclonedx/cyclonedx-npm \
            --output-file sbom.json \
            --output-format JSON

      - name: Validate SBOM structure
        run: |
          node -e "
            const sbom = require('./sbom.json');
            if (sbom.bomFormat !== 'CycloneDX') {
              console.error('Invalid SBOM format:', sbom.bomFormat);
              process.exit(1);
            }
            console.log('SBOM Format:', sbom.bomFormat);
            console.log('Spec Version:', sbom.specVersion);
            console.log('Components:', sbom.components?.length || 0);
          "

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json
          # 90 days for FISMA audit trail requirements
          retention-days: 90

      # ── Job Summary ───────────────────────────────────────────────────────
      - name: Write job summary
        if: always()
        run: |
          echo "## 4. Validation Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Check | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| OSCAL 1.1.2 Schema Tests | Passed |" >> "$GITHUB_STEP_SUMMARY"
          echo "| OSCAL Schema File Integrity | Valid JSON |" >> "$GITHUB_STEP_SUMMARY"
          echo "| CycloneDX SBOM Generation | Generated |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "_SBOM artifact retained for 90 days per FISMA audit requirements._" >> "$GITHUB_STEP_SUMMARY"

  # ===========================================================================
  # STAGE 5A: DEPLOY PREVIEW (Pull Requests only)
  # ===========================================================================
  deploy-preview:
    name: "5. Deploy Preview"
    runs-on: ubuntu-latest
    needs: [test, build, validation]
    if: github.event_name == 'pull_request'
    timeout-minutes: 10

    permissions:
      contents: read
      pull-requests: write
      deployments: write

    outputs:
      preview_url: ${{ steps.deploy.outputs.deployment-url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Deploy to Cloudflare Pages (Preview)
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=forge-reporter --branch=${{ github.head_ref }}

      # ── PR Deployment URL Comment ─────────────────────────────────────────
      - name: Comment deployment URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.deploy.outputs.deployment-url }}' ||
              `https://${context.payload.pull_request.head.ref}.forge-reporter.pages.dev`;

            const body = [
              '## Deployment Preview',
              '',
              '| | |',
              '|---|---|',
              `| **URL** | ${url} |`,
              `| **Branch** | \`${{ github.head_ref }}\` |`,
              `| **Commit** | \`${{ github.sha }}\` |`,
              '| **Status** | Deployed |',
              '',
              '<!-- deploy-preview-comment -->',
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.body.includes('<!-- deploy-preview-comment -->'));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Write job summary
        run: |
          echo "## 5. Preview Deployment" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Deployed to: ${{ steps.deploy.outputs.deployment-url }}" >> "$GITHUB_STEP_SUMMARY"

  # ===========================================================================
  # STAGE 5B: DEPLOY PRODUCTION (main branch only)
  # ===========================================================================
  deploy-production:
    name: "5. Deploy Production"
    runs-on: ubuntu-latest
    needs: [test, build, validation]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 10

    permissions:
      contents: read
      deployments: write

    outputs:
      production_url: ${{ steps.deploy.outputs.deployment-url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Deploy to Cloudflare Pages (Production)
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=forge-reporter --branch=main

      - name: Write job summary
        run: |
          echo "## 5. Production Deployment" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Deployed to: ${{ steps.deploy.outputs.deployment-url }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Commit: \`${{ github.sha }}\`" >> "$GITHUB_STEP_SUMMARY"

  # ===========================================================================
  # STAGE 6A: VERIFY PREVIEW DEPLOYMENT
  # ===========================================================================
  verify-preview:
    name: "6. Verify Preview"
    runs-on: ubuntu-latest
    needs: deploy-preview
    if: github.event_name == 'pull_request'
    timeout-minutes: 5

    steps:
      - name: Wait for CDN propagation
        run: sleep 15

      - name: Smoke test — HTTP status
        id: smoke
        run: |
          URL="${{ needs.deploy-preview.outputs.preview_url }}"
          if [ -z "$URL" ]; then
            URL="https://${{ github.head_ref }}.forge-reporter.pages.dev"
          fi
          echo "Testing: $URL"

          STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$URL" || echo "000")
          echo "HTTP Status: $STATUS"
          echo "status_code=${STATUS}" >> "$GITHUB_OUTPUT"
          echo "url=${URL}" >> "$GITHUB_OUTPUT"

          if [ "$STATUS" -ne 200 ]; then
            echo "::warning::Smoke test returned HTTP $STATUS (expected 200)"
          fi

      - name: Smoke test — content check
        run: |
          URL="${{ needs.deploy-preview.outputs.preview_url }}"
          if [ -z "$URL" ]; then
            URL="https://${{ github.head_ref }}.forge-reporter.pages.dev"
          fi
          BODY=$(curl -s --max-time 30 "$URL" || echo "")
          if echo "$BODY" | grep -q "ForgeComply"; then
            echo "Content check passed: ForgeComply marker found"
          else
            echo "::warning::Content check: ForgeComply marker not found in response"
          fi

      - name: Write job summary
        if: always()
        run: |
          echo "## 6. Smoke Test Results (Preview)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Check | Result |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| URL | ${{ steps.smoke.outputs.url }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| HTTP Status | ${{ steps.smoke.outputs.status_code }} |" >> "$GITHUB_STEP_SUMMARY"

  # ===========================================================================
  # STAGE 6B: VERIFY PRODUCTION DEPLOYMENT
  # ===========================================================================
  verify-production:
    name: "6. Verify Production"
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 5

    steps:
      - name: Wait for CDN propagation
        run: sleep 20

      - name: Smoke test — HTTP status
        id: smoke
        run: |
          URL="${{ needs.deploy-production.outputs.production_url }}"
          if [ -z "$URL" ]; then
            URL="https://forge-reporter.pages.dev"
          fi
          echo "Testing: $URL"

          STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$URL" || echo "000")
          echo "HTTP Status: $STATUS"
          echo "status_code=${STATUS}" >> "$GITHUB_OUTPUT"
          echo "url=${URL}" >> "$GITHUB_OUTPUT"

          if [ "$STATUS" -ne 200 ]; then
            echo "::error::Production smoke test failed with HTTP $STATUS"
            exit 1
          fi

      - name: Smoke test — content check
        run: |
          URL="${{ needs.deploy-production.outputs.production_url }}"
          if [ -z "$URL" ]; then
            URL="https://forge-reporter.pages.dev"
          fi
          BODY=$(curl -s --max-time 30 "$URL" || echo "")
          if echo "$BODY" | grep -q "ForgeComply"; then
            echo "Content check passed"
          else
            echo "::error::Production content check failed: ForgeComply marker not found"
            exit 1
          fi

      - name: Write job summary
        if: always()
        run: |
          echo "## 6. Smoke Test Results (Production)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Check | Result |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| URL | ${{ steps.smoke.outputs.url }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| HTTP Status | ${{ steps.smoke.outputs.status_code }} |" >> "$GITHUB_STEP_SUMMARY"
